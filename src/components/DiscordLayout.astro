---
// Discord Layout Component
import servers from '../data/servers.json';
import users from '../data/users.json';

export interface Props {
  channel?: string;
  server?: string;
}

const { channel = 'general', server = 'research' } = Astro.props;

// Find the current server and channel
const currentServer = servers.servers.find(s => s.id === server) || servers.servers[0];
let currentChannel = null;
let currentCategory = null;

// Find the channel across all categories
for (const category of currentServer.categories) {
  const foundChannel = category.channels.find(c => c.id === channel);
  if (foundChannel) {
    currentChannel = foundChannel;
    currentCategory = category;
    break;
  }
}

// Fallback to first channel of first category
if (!currentChannel && currentServer.categories.length > 0) {
  currentCategory = currentServer.categories[0];
  currentChannel = currentCategory.channels[0];
}
---

<div class="discord-layout">
  <!-- Server Bar (Far Left) -->
  <div class="server-bar">
      {servers.servers.map((serverItem, index) => (
        serverItem.id === server && (
          <div class="active-server-bar" style={`top: ${22 + (index * 56)}px`}></div>
        )
      ))}
      {servers.servers.map((serverItem) => (
        <a href={`/servers/${serverItem.id}/${serverItem.categories[0].channels[0].id}`} class={`server-icon ${serverItem.id === server ? 'active' : ''}`}>
          <div class="server-icon-inner">
            {serverItem.icon.endsWith('.png') ? (
              <img src={serverItem.icon} alt={serverItem.name} class="server-icon-image" />
            ) : (
              serverItem.icon
            )}
          </div>
        </a>
      ))}
    <div class="server-separator"></div>
    <div class="server-icon">
      <div class="server-icon-inner">+</div>
    </div>
  </div>

  <!-- Channel Sidebar (Left) -->
  <div class="channel-sidebar">
    <div class="server-header">
      <h2 class="server-name">{currentServer.name}</h2>
      <div class="server-dropdown">‚ñº</div>
    </div>
    
    <div class="channel-list">
      {currentServer.categories.map((category) => (
        <div class="channel-category">
          <div class="category-header">
            <span class="category-icon">‚ñº</span>
            <span class="category-name">{category.name.toUpperCase()}</span>
          </div>
          <div class="channels">
            {category.channels.map((channelItem) => (
              <a href={`/servers/${server}/${channelItem.id}`} class={`channel ${channelItem.id === channel ? 'active' : ''}`}>
                <span class="channel-icon">#</span>
                <span class="channel-name">{channelItem.name}</span>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>

    <div class="user-info">
      <div class="user-avatar">
        <div class="avatar-inner">U</div>
      </div>
      <div class="user-details">
        <div class="username">User</div>
        <div class="user-status">Online</div>
      </div>
    </div>
  </div>

  <!-- Main Chat Area (Center) -->
  <div class="main-chat">
    <div class="chat-header">
      <div class="channel-info">
        <span class="channel-icon">#</span>
        <span class="channel-name">{channel}</span>
      </div>
      <div class="channel-actions">
        <button class="action-btn">üîî</button>
        <button class="action-btn">üìå</button>
        <button class="action-btn">üë•</button>
        <button class="action-btn">üîç</button>
      </div>
    </div>

    <div class="messages-container">
      <div class="messages">
        <slot />
      </div>
    </div>

    <div class="message-input-container">
      <div class="message-input-wrapper">
        <button class="attachment-btn">+</button>
        <input type="text" class="message-input" placeholder={`Message #${channel}`} />
        <button class="emoji-btn">üòä</button>
      </div>
    </div>
  </div>

  <!-- User Sidebar (Right) -->
  <div class="user-sidebar">
    <div class="sidebar-header">
      <h3>Online ‚Äî {users.users.filter(u => u.status === 'online').length}</h3>
    </div>
    
    <div class="user-list">
      {users.users.map((user) => (
        <div class="user-item">
          <div class={`user-avatar ${user.status}`} style={`background-color: ${user.avatarColor}`}>
            {user.avatarImage ? (
              <img src={user.avatarImage} alt={user.displayName} class="avatar-image" />
            ) : (
              <img src="/avatars/Egg.jpg" alt={user.displayName} class="avatar-image fallback-avatar" />
            )}
          </div>
          <div class="user-info">
            <div class="username">{user.displayName}</div>
            <div class="user-activity">
              {user.status === 'online' ? 'Active' : 
               user.status === 'idle' ? 'Idle' : 
               user.status === 'dnd' ? 'Do Not Disturb' : 'Offline'}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<style>
  .discord-layout {
    display: grid;
    grid-template-columns: 72px 240px 1fr 240px;
    height: 100vh;
    background-color: #36393f;
    color: #dcddde;
    font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  /* Server Bar */
  .server-bar {
    background-color: #202225;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 8px;
    overflow: visible;
  }

  .server-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: #36393f;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    text-decoration: none;
    color: inherit;
  }

  .server-icon:hover {
    background-color: #5865f2;
    border-radius: 50%;
  }

  .server-icon.active {
    background-color: transparent;
  }

  .active-server-bar {
    position: absolute;
    left: 4px;
    width: 4px;
    height: 26px;
    background-color: white;
    border-radius: 0 2px 2px 0;
    top: 22px;
    z-index: 10;
  }

    .server-icon-inner {
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .server-icon-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

  .server-separator {
    width: 32px;
    height: 2px;
    background-color: #36393f;
    border-radius: 1px;
  }

  /* Channel Sidebar */
  .channel-sidebar {
    background-color: #2f3136;
    display: flex;
    flex-direction: column;
  }

  .server-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #202225;
    cursor: pointer;
  }

  .server-name {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
  }

  .server-dropdown {
    color: #b9bbbe;
    font-size: 12px;
  }

  .channel-list {
    flex: 1;
    padding: 8px 0;
  }

  .channel-category {
    margin-bottom: 16px;
  }

  .category-header {
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 4px;
    color: #96989d;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
  }

  .category-icon {
    font-size: 10px;
  }

  .channels {
    margin-top: 4px;
  }

  .channel {
    padding: 6px 16px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    border-radius: 4px;
    margin: 0 8px;
    text-decoration: none;
    color: inherit;
  }

  .channel:hover {
    background-color: #36393f;
  }

  .channel.active {
    background-color: #393c43;
  }

  .channel-icon {
    color: #96989d;
    font-size: 20px;
  }

  .channel-name {
    font-size: 14px;
    color: #96989d;
  }

  .channel.active .channel-name {
    color: #dcddde;
  }

  .user-info {
    height: 52px;
    padding: 0 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #292b2f;
  }

  .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #5865f2;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .avatar-inner {
    color: white;
    font-weight: bold;
    font-size: 14px;
  }

  .user-details {
    flex: 1;
  }

  .username {
    font-size: 14px;
    font-weight: 500;
  }

  .user-status {
    font-size: 12px;
    color: #b9bbbe;
  }

  /* Main Chat */
  .main-chat {
    display: flex;
    flex-direction: column;
    background-color: #36393f;
  }

  .chat-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #202225;
  }

  .channel-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .channel-actions {
    display: flex;
    gap: 16px;
  }

  .action-btn {
    background: none;
    border: none;
    color: #b9bbbe;
    cursor: pointer;
    font-size: 16px;
  }

  .action-btn:hover {
    color: #dcddde;
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px;
    max-height: calc(100vh - 120px); /* Account for header and input */
    scrollbar-width: thin;
    scrollbar-color: #202225 #36393f;
  }

  .messages-container::-webkit-scrollbar {
    width: 8px;
  }

  .messages-container::-webkit-scrollbar-track {
    background: #2f3136;
  }

  .messages-container::-webkit-scrollbar-thumb {
    background: #202225;
    border-radius: 4px;
  }

  .messages-container::-webkit-scrollbar-thumb:hover {
    background: #1a1c1f;
  }

  .messages {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message-input-container {
    padding: 0 16px 24px;
  }

  .message-input-wrapper {
    background-color: #40444b;
    border-radius: 8px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .attachment-btn, .emoji-btn {
    background: none;
    border: none;
    color: #b9bbbe;
    cursor: pointer;
    font-size: 20px;
    padding: 8px;
  }

  .message-input {
    flex: 1;
    background: none;
    border: none;
    color: #dcddde;
    font-size: 14px;
    padding: 12px 0;
    outline: none;
  }

  .message-input::placeholder {
    color: #72767d;
  }

  /* User Sidebar */
  .user-sidebar {
    background-color: #2f3136;
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-height: 100vh;
  }

  .sidebar-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #202225;
  }

  .sidebar-header h3 {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: #96989d;
    margin: 0;
  }

  .user-list {
    flex: 1;
    padding: 8px 0;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #202225 #2f3136;
  }

  .user-list::-webkit-scrollbar {
    width: 8px;
  }

  .user-list::-webkit-scrollbar-track {
    background: #2f3136;
  }

  .user-list::-webkit-scrollbar-thumb {
    background: #202225;
    border-radius: 4px;
  }

  .user-list::-webkit-scrollbar-thumb:hover {
    background: #1a1c1f;
  }

  .user-item {
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
  }

  .user-item:hover {
    background-color: #36393f;
  }

  .user-avatar {
    position: relative;
  }

  .user-avatar .avatar-image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-avatar .fallback-avatar {
    opacity: 0.8;
    filter: grayscale(20%);
  }

  .user-avatar.online::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background-color: #43b581;
    border: 3px solid #2f3136;
    border-radius: 50%;
  }

  .user-avatar.idle::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background-color: #faa61a;
    border: 3px solid #2f3136;
    border-radius: 50%;
  }

  .user-activity {
    font-size: 12px;
    color: #b9bbbe;
  }
</style>
