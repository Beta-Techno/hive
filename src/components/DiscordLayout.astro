---
// Discord Layout Component
import servers from '../data/servers.json';
import users from '../data/users.json';
import TopBar from './TopBar.astro';
import ServerBar from './ServerBar.astro';
import MainChat from './MainChat.astro';
import UserInfo from './UserInfo.astro';

export interface Props {
  channel?: string;
  server?: string;
}

const { channel = 'general', server = 'research' } = Astro.props;

// Get the current logged-in user (nickbg)
const currentLoggedInUser = users.users.find(u => u.id === 'nickbg');

// Find the current server and channel
const currentServer = servers.servers.find(s => s.id === server) || servers.servers[0];
let currentChannel = null;
let currentCategory = null;

// Find the channel across all categories
for (const category of currentServer.categories) {
  const foundChannel = category.channels.find(c => c.id === channel);
  if (foundChannel) {
    currentChannel = foundChannel;
    currentCategory = category;
    break;
  }
}

// Fallback to first channel of first category
if (!currentChannel && currentServer.categories.length > 0) {
  currentCategory = currentServer.categories[0];
  currentChannel = currentCategory.channels[0];
}
---

  <div class="discord-layout">
    <TopBar />
    <ServerBar activeServer={server} isDMPage={false} />

  <!-- Channel Sidebar (Left) -->
  <div class="channel-sidebar">
    <div class="server-header">
      <h2 class="server-name">{currentServer.name}</h2>
      <div class="server-dropdown">
        <img src="/icons/svg/chevron-down.svg" alt="Dropdown" class="dropdown-icon" />
      </div>
    </div>
    
    <div class="channel-list">
      {currentServer.categories.map((category) => (
        <div class="channel-category">
            <div class="category-header" data-category={category.id}>
              <span class="category-name">{category.name.toUpperCase()}</span>
              <span class="category-icon">
                <img src="/icons/svg/chevron-down.svg" alt="Collapse" class="chevron-icon" />
              </span>
            </div>
          <div class="channels">
            {category.channels.map((channelItem) => (
              <a href={`/servers/${server}/${channelItem.id}`} class={`channel ${channelItem.id === channel ? 'active' : ''}`}>
                <span class="channel-icon">
                  <img src="/icons/svg/hash.svg" alt="Channel" class="hash-icon" />
                </span>
                <span class="channel-name">{channelItem.name}</span>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>

    <UserInfo userId={currentLoggedInUser?.id || 'nickbg'} />
  </div>

  <MainChat 
    channelName={currentChannel?.name || channel}
    channelIcon="#"
    placeholder={`Message #${currentChannel?.name || channel}`}
  >
    <slot />
  </MainChat>

  <!-- User Sidebar (Right) -->
  <div class="user-sidebar">
    <div class="sidebar-header">
      <h3>Online â€” {users.users.filter(u => u.status === 'online').length}</h3>
    </div>
    
    <div class="user-list">
      {users.users.map((user) => (
        <div class="user-item">
          <div class={`user-avatar ${user.status}`} style={`background-color: ${user.avatarColor}`}>
            {user.avatarImage ? (
              <img src={user.avatarImage} alt={user.displayName} class="avatar-image" />
            ) : (
              <img src="/avatars/Egg.jpg" alt={user.displayName} class="avatar-image fallback-avatar" />
            )}
          </div>
          <div class="user-info">
            <div class="username">{user.displayName}</div>
            <div class="user-activity">
              {user.status === 'online' ? 'Active' : 
               user.status === 'idle' ? 'Idle' : 
               user.status === 'dnd' ? 'Do Not Disturb' : 'Offline'}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

  <style>
  @import '../styles/discord.css';
    :root {
      /* Discord Color Palette */
      --discord-bg-primary: #1a1a1e;
      --discord-bg-secondary: #121214;
      --discord-bg-tertiary: #202225;
      --discord-bg-quaternary: #292b2f;
      --discord-bg-modifier-hover: #4f545c;
      --discord-bg-modifier-active: #5d6269;
      --discord-bg-modifier-selected: #393c43;
      
      --discord-text-normal: #dcddde;
      --discord-text-muted: #72767d;
      --discord-text-link: #00b0f4;
      --discord-text-positive: #43b581;
      --discord-text-warning: #faa61a;
      --discord-text-danger: #f04747;
      
      --discord-interactive-normal: #b9bbbe;
      --discord-interactive-hover: #dcddde;
      --discord-interactive-active: #fff;
      --discord-interactive-muted: #4f545c;
      
      --discord-accent: #5865f2;
      --discord-accent-hover: #4752c4;
      --discord-accent-active: #3c45a5;
      
      --discord-elevation-low: #2f3136;
      --discord-elevation-medium: #36393f;
      --discord-elevation-high: #40444b;
      --discord-elevation-floating: #202225;
      
      --discord-scrollbar-thin-thumb: #202225;
      --discord-scrollbar-thin-track: #2f3136;
      --discord-scrollbar-auto-thumb: #202225;
      --discord-scrollbar-auto-track: #2f3136;
      --discord-scrollbar-auto-scrollbar-color-thumb: #202225;
      --discord-scrollbar-auto-scrollbar-color-track: #2f3136;
    }

    .discord-layout {
      display: grid;
      grid-template-areas: 
        "top-bar top-bar top-bar top-bar"
        "server-bar channel-sidebar main-chat user-sidebar";
      grid-template-columns: 72px 240px 1fr 240px;
      grid-template-rows: 32px 1fr;
      height: 100vh;
      background-color: var(--discord-bg-primary);
      color: var(--discord-text-normal);
      font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* Top Bar */
    .top-bar {
      grid-area: top-bar;
      background-color: var(--discord-bg-secondary);
      border-bottom: 1px solid var(--discord-bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      height: 32px;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
    }

    .app-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--discord-text-normal);
    }

    .top-bar-center {
      flex: 1;
      display: flex;
      justify-content: center;
      max-width: 400px;
      margin: 0 auto;
    }

    .search-bar {
      width: 100%;
      max-width: 300px;
    }

    .search-input {
      width: 100%;
      background-color: var(--discord-bg-primary);
      border: 1px solid var(--discord-bg-tertiary);
      border-radius: 4px;
      padding: 4px 8px;
      color: var(--discord-text-normal);
      font-size: 12px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--discord-text-muted);
    }

    .search-input:focus {
      border-color: var(--discord-accent);
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-bar-btn {
      background: none;
      border: none;
      color: var(--discord-interactive-normal);
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .top-bar-btn:hover {
      background-color: var(--discord-bg-modifier-hover);
      color: var(--discord-interactive-hover);
    }

  /* Server Bar */
  .server-bar {
    grid-area: server-bar;
    background-color: var(--discord-bg-secondary);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 8px;
    overflow: visible;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .server-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--discord-bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    text-decoration: none;
    color: inherit;
  }

  .server-icon:hover {
    background-color: var(--discord-accent);
    border-radius: 50%;
  }

  .server-icon.active {
    background-color: transparent;
  }

  .home-icon {
    background-color: var(--discord-accent);
  }

  .home-icon:hover {
    background-color: var(--discord-accent-hover);
  }

  .home-icon .server-icon-inner {
    color: white;
  }

  .discord-logo {
    width: 32px;
    height: 32px;
    filter: brightness(0) invert(1); /* Makes the logo white */
  }

  .active-server-bar {
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 26px;
    background-color: white;
    border-radius: 0 2px 2px 0;
    z-index: 10;
  }

    .server-icon-inner {
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .server-icon-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

  .server-separator {
    width: 32px;
    height: 2px;
    background-color: var(--discord-bg-primary);
    border-radius: 1px;
  }

    /* Channel Sidebar */
    .channel-sidebar {
      grid-area: channel-sidebar;
      background-color: var(--discord-bg-secondary);
      display: flex;
      flex-direction: column;
      position: relative;
    }

  .server-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--discord-bg-tertiary);
    cursor: pointer;
  }

  .server-name {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
  }

  .server-dropdown {
    color: var(--discord-interactive-normal);
    font-size: 12px;
  }

  .dropdown-icon {
    width: 12px;
    height: 12px;
    filter: brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(103%) contrast(103%);
  }

  .channel-list {
    flex: 1;
    padding: 8px 0 54px 0;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--discord-scrollbar-auto-thumb) var(--discord-scrollbar-auto-track);
  }

  .channel-list::-webkit-scrollbar {
    width: 8px;
  }

  .channel-list::-webkit-scrollbar-track {
    background: var(--discord-scrollbar-auto-track);
  }

  .channel-list::-webkit-scrollbar-thumb {
    background: var(--discord-scrollbar-auto-thumb);
    border-radius: 4px;
  }

  .channel-list::-webkit-scrollbar-thumb:hover {
    background: var(--discord-bg-tertiary);
  }

  .channel-category {
    margin-bottom: 16px;
  }

  .category-header {
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: var(--discord-text-muted);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    user-select: none;
  }

  .category-icon {
    font-size: 10px;
    transition: transform 0.2s ease;
  }

  .chevron-icon {
    width: 10px;
    height: 10px;
    filter: brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(103%) contrast(103%);
    transition: transform 0.2s ease;
  }

  .category-header.collapsed .chevron-icon {
    transform: rotate(-90deg);
  }

  .channels {
    transition: max-height 0.3s ease, opacity 0.3s ease;
    overflow: hidden;
  }

  .category-header.collapsed + .channels {
    max-height: 0;
    opacity: 0;
  }

  .channels {
    margin-top: 4px;
  }

  .channel {
    padding: 6px 16px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    border-radius: 4px;
    margin: 0 8px;
    text-decoration: none;
    color: inherit;
  }

  .channel:hover {
    background-color: var(--discord-bg-modifier-hover);
  }

  .channel.active {
    background-color: var(--discord-bg-modifier-selected);
  }

  .channel-icon {
    color: var(--discord-text-muted);
    font-size: 20px;
  }

  .hash-icon {
    width: 16px;
    height: 16px;
    filter: brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(103%) contrast(103%);
  }

  .channel-name {
    font-size: 14px;
    color: var(--discord-text-muted);
  }

  .channel.active .channel-name {
    color: var(--discord-text-normal);
  }

  .channel-sidebar .user-info {
    height: 46px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: var(--discord-elevation-high);
    border-radius: 8px;
    margin: 0 16px 24px 16px;
    position: absolute;
    bottom: 0;
    left: 0;
    width: 208px;
    z-index: 10;
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--discord-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .avatar-inner {
    color: white;
    font-weight: bold;
    font-size: 16px;
  }

  .user-details {
    flex: 1;
  }

  .username {
    font-size: 14px;
    font-weight: 500;
  }

  .user-status {
    font-size: 12px;
    color: #b9bbbe;
  }

    /* Main Chat */
    .main-chat {
      grid-area: main-chat;
      display: flex;
      flex-direction: column;
      background-color: var(--discord-bg-primary);
    }

  .chat-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--discord-bg-tertiary);
  }

  .channel-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .channel-actions {
    display: flex;
    gap: 16px;
  }

  .action-btn {
    background: none;
    border: none;
    color: var(--discord-interactive-normal);
    cursor: pointer;
    font-size: 16px;
  }

  .action-btn:hover {
    color: var(--discord-interactive-hover);
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px;
    max-height: calc(100vh - 152px); /* Account for top bar (32px), header and input (120px) */
    scrollbar-width: thin;
    scrollbar-color: #202225 #36393f;
  }

    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: var(--discord-scrollbar-auto-track);
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: var(--discord-scrollbar-auto-thumb);
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: var(--discord-bg-tertiary);
    }

  .messages {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message-input-container {
    padding: 0 16px 24px;
  }

  .message-input-wrapper {
    background-color: var(--discord-elevation-high);
    border-radius: 8px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .attachment-btn, .emoji-btn {
    background: none;
    border: none;
    color: var(--discord-interactive-normal);
    cursor: pointer;
    font-size: 20px;
    padding: 8px;
  }

  .message-input {
    flex: 1;
    background: none;
    border: none;
    color: var(--discord-text-normal);
    font-size: 14px;
    padding: 12px 0;
    outline: none;
  }

  .message-input::placeholder {
    color: var(--discord-text-muted);
  }

    /* User Sidebar */
    .user-sidebar {
      grid-area: user-sidebar;
      background-color: var(--discord-bg-primary);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 32px);
      max-height: calc(100vh - 32px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

  .sidebar-header {
    height: 48px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid var(--discord-bg-tertiary);
  }

  .sidebar-header h3 {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--discord-text-muted);
    margin: 0;
  }

  .user-list {
    flex: 1;
    padding: 8px 0;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #202225 #2f3136;
  }

  .user-list::-webkit-scrollbar {
    width: 8px;
  }

  .user-list::-webkit-scrollbar-track {
    background: #2f3136;
  }

  .user-list::-webkit-scrollbar-thumb {
    background: #202225;
    border-radius: 4px;
  }

  .user-list::-webkit-scrollbar-thumb:hover {
    background: #1a1c1f;
  }

  .user-item {
    padding: 2px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  .user-item:hover {
    background-color: transparent;
  }

  .user-sidebar .user-item .user-info {
    flex: 1;
    min-width: 0;
  }

  .user-sidebar .user-item .username {
    font-size: 14px;
    font-weight: 500;
    color: var(--discord-text-normal);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-avatar {
    position: relative;
    width: 40px;
    height: 40px;
  }

  .user-avatar .avatar-image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-avatar .fallback-avatar {
    opacity: 0.8;
    filter: grayscale(20%);
  }

  .user-avatar.online::after {
    content: '';
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 18px;
    height: 18px;
    background-color: #43b581;
    border: 3px solid var(--discord-bg-primary);
    border-radius: 50%;
  }

  .user-avatar.idle::after {
    content: '';
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 18px;
    height: 18px;
    background-color: #faa61a;
    border: 3px solid var(--discord-bg-primary);
    border-radius: 50%;
  }

  .user-activity {
    display: none;
  }
</style>

<script>
  // Make channel categories collapsible
  document.addEventListener('DOMContentLoaded', function() {
    const categoryHeaders = document.querySelectorAll('.category-header');
    
    categoryHeaders.forEach(header => {
      header.addEventListener('click', function(this: HTMLElement) {
        this.classList.toggle('collapsed');
      });
    });
  });
</script>
